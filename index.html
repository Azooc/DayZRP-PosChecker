<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADM Map Viewer</title>
<style>
  :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--danger:#ff4d4d}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071021 0%,var(--bg) 100%);color:#e6eef6;display:flex;flex-direction:column;align-items:center;padding:20px}
  .wrap{width:min(1200px,95%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.25rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;cursor:pointer;color:inherit}
  select{padding:6px;border-radius:6px;background:var(--panel);color:inherit;border:1px solid rgba(255,255,255,0.08)}
  .panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px}
  .viewport{position:relative;height:75vh;min-height:420px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;background:#000;user-select:none;touch-action:none}
  .stage{position:absolute;left:0;top:0;transform-origin:0 0}
  .stage img{display:block}
  .markers{position:absolute;left:0;top:0}
  .dot{
    position:absolute;
    width:16px; height:16px;
    background:var(--danger);
    border:1px solid rgba(255,255,255,0.7);
    border-radius:50%;
    transform:translate(-50%,-50%);
    pointer-events:auto;
  }
  .dot:hover::after{
    content:attr(data-info);
    position:absolute;
    top:-26px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.85);
    color:#fff;
    padding:4px 8px;
    border-radius:6px;
    font-size:0.9rem;
    white-space:nowrap;
    pointer-events:none;
    z-index:1000;
  }
  .arrow {
    position:absolute;
    height:2px;
    background:var(--accent);
    transform-origin:0 50%;
    opacity:0.6;
  }
  #playerList {
    max-height:150px;
    overflow-y:auto;
    font-size:0.9rem;
  }
  #playerList label {
    display:block;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ADM Map Viewer</h1>
      <div class="controls">
        <label class="btn">üìÅ Upload ADM<input type="file" id="fileInput" accept=".txt,.log,.adm"/></label>
        <button class="btn" id="fitBtn" title="Fit to screen">Fit</button>
      </div>
    </header>

    <!-- Log pulling panel -->
    <div class="panel">
      <div>
        Start: <select id="startTime"></select>
        End: <select id="endTime"></select>
      </div>
      <div id="playerList"></div>
    </div>

    <div class="viewport panel" id="viewport">
      <div class="stage" id="stage">
        <img id="map" src="map.jpg" alt="Map"/>
        <div class="markers" id="markers"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const WORLD = 12800;

  const fileInput = document.getElementById('fileInput');
  const viewport = document.getElementById('viewport');
  const stage = document.getElementById('stage');
  const mapImg = document.getElementById('map');
  const markers = document.getElementById('markers');
  const fitBtn = document.getElementById('fitBtn');

  const startTimeSel = document.getElementById('startTime');
  const endTimeSel = document.getElementById('endTime');
  const playerListDiv = document.getElementById('playerList');

  let snapshots = new Map();
  let orderedTimestamps = [];
  let imgW = 0, imgH = 0;

  let scale = 1, tx = 0, ty = 0;
  const MIN_SCALE = 0.001, MAX_SCALE = 200;

  let selectedPlayers = new Set();

  const lineRe =
  /^(?<time>\d{2}:\d{2}:\d{2})\s*\|\s*Player\s+"(?<name>.+?)"\s*\(id=(?<id>\d+)\s+pos=<\s*(?<x>[-+\d.]+)\s*,\s*(?<z>[-+\d.]+)\s*,\s*(?<y>[-+\d.]+)\s*>\)\s*$/i;

  function parseADM(text){
    snapshots.clear(); orderedTimestamps=[];
    const lines = text.split(/\r?\n/);
    for(const raw of lines){
      const m = raw.match(lineRe);
      if(!m) continue;
      const { time, name, id, x, z, y } = m.groups;
      if(!snapshots.has(time)){ snapshots.set(time, []); orderedTimestamps.push(time); }
      snapshots.get(time).push({ name, id, x:+x, z:+z, y:+y });
    }
  }

  function populateTimestamps(){
    startTimeSel.innerHTML = '';
    endTimeSel.innerHTML = '';
    for(const t of orderedTimestamps){
      const o1 = document.createElement('option');
      o1.value = t; o1.textContent = t;
      startTimeSel.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = t; o2.textContent = t;
      endTimeSel.appendChild(o2);
    }
    if(orderedTimestamps.length){
      startTimeSel.value = orderedTimestamps[0];
      endTimeSel.value = orderedTimestamps[0];
    }
  }

  function populatePlayerList(players){
    playerListDiv.innerHTML = '';
    const names = [...new Set(players.map(p=>p.name))].sort();
    for(const n of names){
      const id = 'pl_'+n.replace(/\W+/g,'_');
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.checked=true;
      cb.addEventListener('change', ()=>{
        if(cb.checked) selectedPlayers.add(n);
        else selectedPlayers.delete(n);
        renderRange();
      });
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+n));
      playerListDiv.appendChild(label);
      selectedPlayers.add(n);
    }
  }

  function worldToImagePx(p){
    const xpx = (p.x / WORLD) * imgW;
    const ypx = imgH - (p.z / WORLD) * imgH;
    return { xpx, ypx };
  }

  function renderRange(){
    markers.innerHTML = '';
    if(!orderedTimestamps.length) return;

    const startIdx = orderedTimestamps.indexOf(startTimeSel.value);
    const endIdx = orderedTimestamps.indexOf(endTimeSel.value);
    if(startIdx < 0 || endIdx < 0) return;

    const [a,b] = [Math.min(startIdx,endIdx), Math.max(startIdx,endIdx)];
    const range = orderedTimestamps.slice(a,b+1);

    // Build path history
    const playerPaths = new Map();
    for(const t of range){
      for(const p of snapshots.get(t)){
        if(!selectedPlayers.has(p.name)) continue;
        if(!playerPaths.has(p.name)) playerPaths.set(p.name,[]);
        playerPaths.get(p.name).push(p);
      }
    }

    for(const [name, positions] of playerPaths){
      let prev=null;
      for(const pos of positions){
        const {xpx,ypx} = worldToImagePx(pos);
        const d=document.createElement('div');
        d.className='dot';
        d.style.left=xpx+'px';
        d.style.top=ypx+'px';
        d.setAttribute('data-info', `${name} (${pos.x.toFixed(1)},${pos.z.toFixed(1)})`);
        markers.appendChild(d);

        if(prev){
          const dx = xpx - prev.xpx, dy = ypx - prev.ypx;
          const len = Math.sqrt(dx*dx+dy*dy);
          const angle = Math.atan2(dy,dx)*180/Math.PI;
          const line=document.createElement('div');
          line.className='arrow';
          line.style.left=prev.xpx+'px';
          line.style.top=prev.ypx+'px';
          line.style.width=len+'px';
          line.style.transform=`rotate(${angle}deg)`;
          markers.appendChild(line);
        }
        prev={xpx,ypx};
      }
    }
    applyTransform();
  }

  function applyTransform(){
    stage.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    markers.querySelectorAll('.dot').forEach(el=>{
      el.style.transform = `translate(-50%,-50%) scale(${1/(scale*1.5)})`;
    });
    markers.querySelectorAll('.arrow').forEach(el=>{
      el.style.transform += ` scaleX(${1/scale})`;
    });
  }

  function fitToViewport(){
    if(!imgW || !imgH) return;
    const vw = viewport.clientWidth, vh = viewport.clientHeight;
    const s = Math.min(vw/imgW, vh/imgH);
    scale = s;
    tx = (vw - imgW*scale)/2;
    ty = (vh - imgH*scale)/2;
    applyTransform();
  }

  function zoomAt(cx, cy, factor){
    const oldScale = scale;
    let newScale = scale * factor;
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    const k = newScale/oldScale;
    const sx = (cx - tx);
    const sy = (cy - ty);
    tx = cx - sx * k;
    ty = cy - sy * k;
    scale = newScale;
    applyTransform();
  }

  viewport.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const factor = (e.deltaY < 0) ? 1.15 : 1/1.15;
    const rect = viewport.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    zoomAt(cx, cy, factor);
  }, { passive:false });

  let dragging = false, lx=0, ly=0;
  viewport.addEventListener('mousedown', (e)=>{
    dragging = true; lx = e.clientX; ly = e.clientY;
  });
  window.addEventListener('mouseup', ()=> dragging=false);
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const dx = e.clientX - lx, dy = e.clientY - ly;
    lx = e.clientX; ly = e.clientY;
    tx += dx; ty += dy;
    applyTransform();
  });

  fitBtn.addEventListener('click', fitToViewport);
  startTimeSel.addEventListener('change', renderRange);
  endTimeSel.addEventListener('change', renderRange);

  fileInput.addEventListener('change', e=>{
    if(!e.target.files[0]) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      parseADM(reader.result);
      populateTimestamps();
      const allPlayers = [...snapshots.values()].flat();
      populatePlayerList(allPlayers);
      renderRange();
      fitToViewport();
    };
    reader.readAsText(e.target.files[0]);
  });

  mapImg.addEventListener('load', ()=>{
    imgW = mapImg.naturalWidth;
    imgH = mapImg.naturalHeight;
    stage.style.width = imgW + 'px';
    stage.style.height = imgH + 'px';
    markers.style.width = imgW + 'px';
    markers.style.height = imgH + 'px';
    fitToViewport();
  });
})();
</script>
</body>
</html>
