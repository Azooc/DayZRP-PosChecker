<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADM Map Viewer</title>
<style>
  :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071021 0%,var(--bg) 100%);color:#e6eef6;display:flex;flex-direction:column;align-items:center;padding:20px}
  .wrap{width:min(1200px,95%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.25rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;cursor:pointer;color:inherit}

  .panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px}

  .viewport{position:relative;height:75vh;min-height:420px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;background:#000;user-select:none;touch-action:none}
  .stage{position:absolute;left:0;top:0;transform-origin:0 0}
  .stage img{display:block}
  .overlay{position:absolute;left:0;top:0;width:100%;height:100%}

  /* Player list */
  #playerControls{display:flex;gap:6px;margin:10px 0}
  #playerList{max-height:180px;overflow:auto;font-size:0.9rem;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
  #playerList label{display:flex;gap:8px;align-items:center}

  .colorSwatch{
    width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid #fff3;
  }

  /* Color wheel popup */
  .colorWheelBox {
    position:absolute;
    z-index:2000;
    display:none;
    background:var(--panel);
    border:1px solid rgba(255,255,255,0.15);
    border-radius:12px;
    padding:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.6);
  }
  #colorWheel {
    display:block;
    border-radius:50%;
  }

  /* SVG appearance */
  .track{stroke-width:4;opacity:0.9;stroke-linecap:round}
  .poi{stroke:#fff;stroke-width:2}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ADM Map Viewer</h1>
      <div class="controls">
        <label class="btn">üìÅ Upload ADM<input type="file" id="fileInput" accept=".txt,.log,.adm"/></label>
        <button class="btn" id="fitBtn" title="Fit to screen">Fit</button>
      </div>
    </header>

    <!-- Log pulling -->
    <div class="panel">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div>Start: <select id="startTime"></select></div>
        <div>End: <select id="endTime"></select></div>
      </div>
      <div id="playerControls">
        <button class="btn" id="selectAllBtn">Select All</button>
        <button class="btn" id="clearAllBtn">Clear All</button>
      </div>
      <div id="playerList"></div>
    </div>

    <div class="viewport panel" id="viewport">
      <div class="stage" id="stage">
        <img id="map" src="map.jpg" alt="Map"/>
        <svg id="overlay" class="overlay" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
              <path d="M0,0 L6,3 L0,6 Z" fill="context-stroke"></path>
            </marker>
          </defs>
          <g id="tracks"></g>
          <g id="dots"></g>
        </svg>
      </div>
    </div>
  </div>

  <!-- Color wheel popup -->
  <div id="colorWheelBox" class="colorWheelBox">
    <canvas id="colorWheel" width="160" height="160"></canvas>
  </div>

<script>
(() => {
  const WORLD = 12800;
  const BRIGHT_COLORS = ["#ff0000","#00ff00","#0000ff","#ff00ff","#00ffff","#ffff00","#ff8800","#00ff88","#8800ff","#ff0088","#88ff00","#0088ff"];
  let usedColors = new Set();

  const playerListDiv = document.getElementById('playerList');
  const colorWheelBox = document.getElementById('colorWheelBox');
  const colorWheel = document.getElementById('colorWheel');
  const ctx = colorWheel.getContext('2d');
  const wheelSize = 160;

  // Draw color wheel
  function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l;}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
  function drawWheel(){
    const r=wheelSize/2;
    const image=ctx.createImageData(wheelSize,wheelSize);
    const data=image.data;
    for(let y=0;y<wheelSize;y++){
      for(let x=0;x<wheelSize;x++){
        const dx=x-r,dy=y-r,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<=r){
          let angle=Math.atan2(dy,dx)*180/Math.PI;
          if(angle<0) angle+=360;
          const [rr,gg,bb]=hslToRgb(angle/360,1,0.5);
          const idx=(y*wheelSize+x)*4;
          data[idx]=rr;data[idx+1]=gg;data[idx+2]=bb;data[idx+3]=255;
        }
      }
    }
    ctx.putImageData(image,0,0);
  }
  drawWheel();
  function getColorAt(e){
    const rect=colorWheel.getBoundingClientRect();
    const x=Math.floor(e.clientX-rect.left);
    const y=Math.floor(e.clientY-rect.top);
    const d=ctx.getImageData(x,y,1,1).data;
    return `rgb(${d[0]},${d[1]},${d[2]})`;
  }

  // State
  let playerColors=new Map(), selectedPlayers=new Set(), currentColorTarget=null;

  function autoAssignColor(n){
    for(const c of BRIGHT_COLORS){
      if(!usedColors.has(c)){
        playerColors.set(n,c);
        usedColors.add(c);
        return;
      }
    }
    playerColors.set(n,`hsl(${Math.random()*360},100%,50%)`);
  }

  function populatePlayerList(names){
    playerListDiv.innerHTML='';
    names.forEach(n=>{
      if(!playerColors.has(n)) playerColors.set(n,'#ff0000');
      selectedPlayers.add(n);

      const label=document.createElement('label');
      const cb=document.createElement('input');
      cb.type='checkbox';cb.checked=selectedPlayers.has(n);
      cb.addEventListener('change',()=>{
        if(cb.checked){
          selectedPlayers.add(n);
          if(playerColors.get(n)==='#ff0000'){autoAssignColor(n);}
        } else selectedPlayers.delete(n);
        populatePlayerList(names); // refresh swatches
      });

      const swatch=document.createElement('div');
      swatch.className='colorSwatch';
      swatch.style.background=playerColors.get(n);
      swatch.addEventListener('click',(e)=>{
        currentColorTarget=n;
        colorWheelBox.style.display='block';
        colorWheelBox.style.left=(e.pageX-90)+'px';
        colorWheelBox.style.top=(e.pageY-90)+'px';
      });

      label.appendChild(cb);
      label.appendChild(swatch);
      label.appendChild(document.createTextNode(' '+n));
      playerListDiv.appendChild(label);
    });
  }

  // Wheel click
  colorWheel.addEventListener('click',e=>{
    if(!currentColorTarget)return;
    const c=getColorAt(e);
    playerColors.set(currentColorTarget,c);
    usedColors.add(c);
    currentColorTarget=null;
    colorWheelBox.style.display='none';
    populatePlayerList([...playerColors.keys()]);
  });

  // Demo list
  populatePlayerList(["Alice","Bob","Charlie"]);
})();
</script>
</body>
</html>
