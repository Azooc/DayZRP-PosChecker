<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADM Position Viewer</title>
<style>
  :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071021 0%,var(--bg) 100%);color:#e6eef6;display:flex;flex-direction:column;align-items:center;padding:12px}
  .wrap{width:min(98%,1900px);max-width:1900px;display:flex;flex-direction:column;gap:10px;height:100%}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:1.25rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;cursor:pointer;color:inherit}
  select{padding:6px;border-radius:6px;background:var(--panel);color:inherit;border:1px solid rgba(255,255,255,0.08)}
  .viewer{flex:1;position:relative;overflow:hidden;background:#000;border:1px solid rgba(255,255,255,0.08);border-radius:8px}
  #stage{position:absolute;top:0;left:0;transform-origin:0 0}
  #mapImg{display:block;max-width:none;user-select:none;pointer-events:none}
  #markers{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
  .dot{
    position:absolute;
    width:20px; height:20px; /* hover area */
    transform:translate(-50%,-50%);
    pointer-events:auto;
  }
  .dot::before{
    content:'';
    position:absolute;
    top:50%; left:50%;
    width:10px; height:10px;
    border-radius:50%;
    background:red;
    transform:translate(-50%,-50%);
  }
  .dot:hover::after{
    content:attr(data-name);
    position:absolute;
    top:-28px;left:12px;
    background:rgba(0,0,0,0.8);
    color:#fff;
    padding:6px 8px;
    border-radius:6px;
    white-space:nowrap;
    font-size:1rem;
    z-index:100;
    pointer-events:none;
  }
  footer{font-size:0.8rem;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ADM Position Viewer</h1>
      <div class="controls">
        <label class="btn" id="chooseFileBtn">üìÅ Upload ADM</label>
        <input id="fileInput" type="file" accept=".txt,.log"/>
        <select id="timestampSelect"><option value="">Select timestamp</option></select>
        <button class="btn" id="fitBtn">Fit</button>
      </div>
    </header>
    <div class="viewer" id="viewport">
      <div id="stage">
        <img id="mapImg" src="bigmap.png" alt="Map"/>
        <div id="markers"></div>
      </div>
    </div>
    <footer>DayZRP - ADM Tool</footer>
  </div>

<script>
(()=>{
  let entriesByTime = {};
  let imgW=0, imgH=0;
  let scale=1, tx=0, ty=0;
  const MIN_SCALE=0.001, MAX_SCALE=200;

  const fileInput=document.getElementById('fileInput');
  const chooseFileBtn=document.getElementById('chooseFileBtn');
  const timestampSelect=document.getElementById('timestampSelect');
  const fitBtn=document.getElementById('fitBtn');
  const viewport=document.getElementById('viewport');
  const stage=document.getElementById('stage');
  const mapImg=document.getElementById('mapImg');
  const markers=document.getElementById('markers');

  chooseFileBtn.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',e=>{
    if(e.target.files&&e.target.files[0]) handleFile(e.target.files[0]);
  });

  mapImg.addEventListener('load',()=>{
    imgW=mapImg.naturalWidth;
    imgH=mapImg.naturalHeight;
    stage.style.width=imgW+'px';
    stage.style.height=imgH+'px';
    markers.style.width=imgW+'px';
    markers.style.height=imgH+'px';
    fitToViewport();
  });

  function fitToViewport(){
    if(!imgW||!imgH) return;
    const vw=viewport.clientWidth, vh=viewport.clientHeight;
    const s=Math.min(vw/imgW, vh/imgH);
    scale=s; // no clamp here so it really fits
    tx=(vw-imgW*scale)/2;
    ty=(vh-imgH*scale)/2;
    applyTransform();
  }

  function applyTransform(){
    stage.style.transform=`translate(${tx}px,${ty}px) scale(${scale})`;
    markers.querySelectorAll('.dot').forEach(el=>{
      let inv=1/scale;
      if(inv>1) inv=1;
      if(inv<0.3) inv=0.3;
      el.style.transform=`translate(-50%,-50%) scale(${inv})`;
    });
  }

  viewport.addEventListener('wheel',e=>{
    e.preventDefault();
    const rect=viewport.getBoundingClientRect();
    const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    const wx=(mx-tx)/scale, wy=(my-ty)/scale;
    let ds=(e.deltaY<0)?1.1:0.9;
    let newScale=scale*ds;
    newScale=Math.min(MAX_SCALE,Math.max(MIN_SCALE,newScale));
    tx=mx-wx*newScale;
    ty=my-wy*newScale;
    scale=newScale;
    applyTransform();
  },{passive:false});

  let dragging=false, lastX=0, lastY=0;
  viewport.addEventListener('mousedown',e=>{
    dragging=true; lastX=e.clientX; lastY=e.clientY;
  });
  viewport.addEventListener('mouseup',()=>dragging=false);
  viewport.addEventListener('mouseleave',()=>dragging=false);
  viewport.addEventListener('mousemove',e=>{
    if(dragging){
      tx+=e.clientX-lastX;
      ty+=e.clientY-lastY;
      lastX=e.clientX; lastY=e.clientY;
      applyTransform();
    }
  });

  fitBtn.addEventListener('click',fitToViewport);

  function handleFile(file){
    const reader=new FileReader();
    reader.onload=()=>{
      parseLog(String(reader.result||''));
      updateDropdown();
    };
    reader.readAsText(file);
  }

  function parseLog(text){
    entriesByTime={};
    const regex=/^(\d{2}:\d{2}:\d{2}) \| Player "([^"]+)" \(id=\d+ pos=<([\d.]+), ([\d.]+), ([\d.]+)>\)/gm;
    let m;
    while((m=regex.exec(text))!==null){
      const time=m[1];
      const name=m[2];
      const x=parseFloat(m[3]);
      const z=parseFloat(m[4]);
      const y=parseFloat(m[5]);
      if(!entriesByTime[time]) entriesByTime[time]=[];
      entriesByTime[time].push({name,x,z,y});
    }
  }

  function updateDropdown(){
    timestampSelect.innerHTML='<option value="">Select timestamp</option>';
    Object.keys(entriesByTime).forEach(t=>{
      const opt=document.createElement('option');
      opt.value=t; opt.textContent=t;
      timestampSelect.appendChild(opt);
    });
  }

  timestampSelect.addEventListener('change',()=>{
    const t=timestampSelect.value;
    if(t) showTime(t);
  });

  function showTime(t){
    markers.innerHTML='';
    const players=entriesByTime[t];
    if(!players) return;
    players.forEach(p=>{
      const dot=document.createElement('div');
      dot.className='dot';
      const px=p.x/12800*imgW;
      const py=(12800-p.z)/12800*imgH;
      dot.style.left=px+'px';
      dot.style.top=py+'px';
      dot.setAttribute('data-name',`${p.name} (${p.x.toFixed(1)}, ${p.z.toFixed(1)})`);
      markers.appendChild(dot);
    });
    applyTransform();
  }
})();
</script>
</body>
</html>
