<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADM Map Viewer</title>
<style>
  :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--danger:#ff4d4d}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071021 0%,var(--bg) 100%);color:#e6eef6;display:flex;flex-direction:column;align-items:center;padding:20px}
  .wrap{width:min(1200px,95%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:1.25rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;cursor:pointer;color:inherit}
  select{padding:6px;border-radius:6px;background:var(--panel);color:inherit;border:1px solid rgba(255,255,255,0.08)}
  .panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .viewport{position:relative;height:75vh;min-height:420px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);overflow:hidden;background:#000;user-select:none;touch-action:none}
  .stage{position:absolute;left:0;top:0;transform-origin:0 0}
  .stage img{display:block}
  .markers{position:absolute;left:0;top:0}
  .dot{
    position:absolute;
    width:20px; height:20px;
    background:transparent;
    border-radius:50%;
    transform:translate(-50%,-50%);
    pointer-events:auto;
  }
  .dot::before{
    content:"";
    display:block;
    width:10px; height:10px;
    background:var(--danger);
    border:1px solid rgba(255,255,255,0.7);
    border-radius:50%;
    margin:auto;
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
  }
  .dot:hover::after{
    content:attr(data-info);
    position:absolute;
    top:-36px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.85);
    color:#fff;
    padding:6px 10px;
    border-radius:6px;
    font-size:1rem;
    white-space:nowrap;
    pointer-events:none;
    z-index:1000;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ADM Map Viewer</h1>
      <div class="controls">
        <label class="btn">üìÅ Upload ADM<input type="file" id="fileInput" accept=".txt,.log,.adm"/></label>
        <select id="timestampSelect"></select>
        <button class="btn" id="fitBtn" title="Fit to screen">Fit</button>
      </div>
    </header>

    <div class="viewport panel" id="viewport">
      <div class="stage" id="stage">
        <!-- Your half-size map: 6400 x 6400 -->
        <img id="map" src="map_half.jpg" alt="Map"/>
        <div class="markers" id="markers"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const WORLD = 12800; // world coordinates are 0..12800

  const fileInput = document.getElementById('fileInput');
  const tsSelect = document.getElementById('timestampSelect');
  const viewport = document.getElementById('viewport');
  const stage = document.getElementById('stage');
  const mapImg = document.getElementById('map');
  const markers = document.getElementById('markers');
  const fitBtn = document.getElementById('fitBtn');

  let snapshots = new Map();
  let orderedTimestamps = [];
  let imgW = 0, imgH = 0;

  let scale = 1, tx = 0, ty = 0;
  const MIN_SCALE = 0.001, MAX_SCALE = 200;

  const lineRe =
  /^(?<time>\d{2}:\d{2}:\d{2})\s*\|\s*Player\s+"(?<name>.+?)"\s*\(id=(?<id>\d+)\s+pos=<\s*(?<x>[-+\d.]+)\s*,\s*(?<z>[-+\d.]+)\s*,\s*(?<y>[-+\d.]+)\s*>\)\s*$/i;

  function parseADM(text){
    snapshots.clear(); orderedTimestamps=[];
    const lines = text.split(/\r?\n/);
    for(const raw of lines){
      const m = raw.match(lineRe);
      if(!m) continue;
      const { time, name, id, x, z, y } = m.groups;
      if(!snapshots.has(time)){ snapshots.set(time, []); orderedTimestamps.push(time); }
      snapshots.get(time).push({ name, id, x:+x, z:+z, y:+y });
    }
  }

  function populateTimestamps(){
    tsSelect.innerHTML = '';
    if(!orderedTimestamps.length){
      const o = document.createElement('option');
      o.value=''; o.textContent='No timestamps found';
      tsSelect.appendChild(o);
      return;
    }
    for(const t of orderedTimestamps){
      const o = document.createElement('option');
      const count = snapshots.get(t).length;
      o.value = t; o.textContent = `${t} (${count})`;
      tsSelect.appendChild(o);
    }
  }

  function worldToImagePx(p){
    // Scale from world (0..12800) into image (0..imgW)
    const xpx = (p.x / WORLD) * imgW;
    const ypx = imgH - (p.z / WORLD) * imgH;
    return { xpx, ypx };
  }

  function renderDots(players){
    markers.innerHTML = '';
    markers.style.width = imgW + 'px';
    markers.style.height = imgH + 'px';
    for(const p of players){
      const { xpx, ypx } = worldToImagePx(p);
      const d = document.createElement('div');
      d.className = 'dot';
      d.style.left = xpx + 'px';
      d.style.top  = ypx + 'px';
      d.setAttribute('data-info', `${p.name} (${p.x.toFixed(1)}, ${p.z.toFixed(1)})`);
      markers.appendChild(d);
    }
    applyTransform();
  }

  function applyTransform(){
    stage.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    const inv = 1/(scale*1.5);
    markers.querySelectorAll('.dot').forEach(el=>{
      el.style.transform = `translate(-50%,-50%) scale(${inv})`;
    });
  }

  function fitToViewport(){
    if(!imgW || !imgH) return;
    const vw = viewport.clientWidth, vh = viewport.clientHeight;
    const s = Math.min(vw/imgW, vh/imgH);
    scale = s;
    tx = (vw - imgW*scale)/2;
    ty = (vh - imgH*scale)/2;
    applyTransform();
  }

  function zoomAt(cx, cy, factor){
    const oldScale = scale;
    let newScale = scale * factor;
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    const k = newScale/oldScale;
    const sx = (cx - tx);
    const sy = (cy - ty);
    tx = cx - sx * k;
    ty = cy - sy * k;
    scale = newScale;
    applyTransform();
  }

  viewport.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const factor = (e.deltaY < 0) ? 1.15 : 1/1.15;
    const rect = viewport.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    zoomAt(cx, cy, factor);
  }, { passive:false });

  let dragging = false, lx=0, ly=0;
  viewport.addEventListener('mousedown', (e)=>{
    dragging = true; lx = e.clientX; ly = e.clientY;
  });
  window.addEventListener('mouseup', ()=> dragging=false);
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const dx = e.clientX - lx, dy = e.clientY - ly;
    lx = e.clientX; ly = e.clientY;
    tx += dx; ty += dy;
    applyTransform();
  });

  viewport.addEventListener('dblclick', ()=> fitToViewport());
  fitBtn.addEventListener('click', fitToViewport);

  tsSelect.addEventListener('change', ()=>{
    const t = tsSelect.value;
    renderDots(snapshots.get(t)||[]);
  });

  fileInput.addEventListener('change', e=>{
    if(!e.target.files[0]) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      parseADM(reader.result);
      populateTimestamps();
      if(orderedTimestamps.length){
        tsSelect.value = orderedTimestamps[0];
        renderDots(snapshots.get(orderedTimestamps[0]));
        fitToViewport();
      }
    };
    reader.readAsText(e.target.files[0]);
  });

  mapImg.addEventListener('load', ()=>{
    imgW = mapImg.naturalWidth;
    imgH = mapImg.naturalHeight;
    stage.style.width = imgW + 'px';
    stage.style.height = imgH + 'px';
    markers.style.width = imgW + 'px';
    markers.style.height = imgH + 'px';
    fitToViewport();
  });
})();
</script>
</body>
</html>
