<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADM Map Plotter</title>
<style>
  :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--danger:#ff4d4d}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071021 0%,var(--bg) 100%);color:#e6eef6;display:flex;flex-direction:column;align-items:center;padding:28px}
  .wrap{width:min(1200px,95%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  h1{margin:0;font-size:1.25rem}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;cursor:pointer;color:inherit}
  .panel{background:var(--panel);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06)}
  .small{font-size:0.9rem;color:var(--muted)}
  select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:inherit}
  .map-wrap{position:relative;width:100%;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:#000}
  .map-wrap img{display:block;width:100%;height:auto}
  .marker{position:absolute;width:10px;height:10px;background:var(--danger);border:1px solid rgba(255,255,255,0.7);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 0 2px rgba(255,77,77,0.25)}
  .tooltip{position:absolute;left:50%;transform:translateX(-50%);top:-10px;translate:0 -8px;background:rgba(0,0,0,0.75);padding:5px 8px;border-radius:6px;font-size:12px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .12s}
  .marker:hover .tooltip{opacity:1}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ADM Map Plotter</h1>
      <div class="controls">
        <label class="btn" id="chooseFileBtn">üìÅ Upload ADM</label>
        <input id="fileInput" type="file" accept=".adm,.log,.txt"/>
        <span id="status" class="small">No file loaded</span>
      </div>
    </header>

    <div class="panel" style="margin-bottom:12px">
      <label class="small">Timestamp
        <select id="timestampSelect"></select>
      </label>
      <span id="summary" class="small" style="margin-left:10px">Players: 0</span>
    </div>

    <div class="map-wrap" id="mapWrap">
      <img id="mapImg" src="map.jpg" alt="Map"/>
    </div>
  </div>

<script>
(() => {
  const WORLD = 12800;           // hard-coded world extent
  const MINX = 0, MAXX = 12800;  // left -> right
  const MINZ = 0, MAXZ = 12800;  // bottom -> top

  const fileInput = document.getElementById('fileInput');
  const chooseFileBtn = document.getElementById('chooseFileBtn');
  const statusEl = document.getElementById('status');
  const timestampSelect = document.getElementById('timestampSelect');
  const summary = document.getElementById('summary');
  const mapWrap = document.getElementById('mapWrap');
  const mapImg = document.getElementById('mapImg');

  let snapshots = new Map();
  let orderedTimestamps = [];

  chooseFileBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => {
    if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
  });

  timestampSelect.addEventListener('change', () => renderTimestamp(timestampSelect.value));
  mapImg.addEventListener('load', () => { if (timestampSelect.value) renderTimestamp(timestampSelect.value); });
  window.addEventListener('resize', () => { if (timestampSelect.value) renderTimestamp(timestampSelect.value); });

  function handleFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      parseADM(String(reader.result || ''));
      populateTimestamps();
      statusEl.textContent = `Loaded: ${file.name}`;
      if (orderedTimestamps.length) {
        timestampSelect.value = orderedTimestamps[0];
        renderTimestamp(orderedTimestamps[0]);
      }
    };
    reader.onerror = () => alert('Failed to read file');
    reader.readAsText(file);
  }

  const lineRe = /^(?<time>\d{2}:\d{2}:\d{2})\s*\|\s*Player\s+"(?<name>.+?)"\s*\(id=(?<id>\d+)\s+pos=<\s*(?<x>[-+\d.]+)\s*,\s*(?<y>[-+\d.]+)\s*,\s*(?<z>[-+\d.]+)\s*>\)/i;

  function parseADM(text) {
    snapshots = new Map();
    orderedTimestamps = [];
    for (const raw of text.split(/\r?\n/)) {
      const line = raw.trim();
      if (!line) continue;
      const m = line.match(lineRe);
      if (!m) continue;
      const { time, name, id, x, y, z } = m.groups;
      if (!snapshots.has(time)) { snapshots.set(time, []); orderedTimestamps.push(time); }
      snapshots.get(time).push({ name, id, x: +x, y: +y, z: +z });
    }
  }

  function populateTimestamps() {
    timestampSelect.innerHTML = '';
    if (!orderedTimestamps.length) {
      const opt = document.createElement('option');
      opt.value = ''; opt.textContent = 'No timestamps found';
      timestampSelect.appendChild(opt);
      summary.textContent = 'Players: 0';
      return;
    }
    for (const t of orderedTimestamps) {
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      timestampSelect.appendChild(opt);
    }
  }

  function renderTimestamp(ts) {
    const players = snapshots.get(ts) || [];
    summary.textContent = `Players: ${players.length}`;
    [...mapWrap.querySelectorAll('.marker')].forEach(el => el.remove());

    const spanX = (MAXX - MINX) || 1;
    const spanZ = (MAXZ - MINZ) || 1;

    for (const p of players) {
      // clamp to bounds just in case
      const x = Math.min(MAXX, Math.max(MINX, p.x));
      const z = Math.min(MAXZ, Math.max(MINZ, p.z));

      const nx = (x - MINX) / spanX;          // 0..1 left‚Üíright
      const nz = (z - MINZ) / spanZ;          // 0..1 bottom‚Üítop
      const leftPct = nx * 100;
      const topPct  = (1 - nz) * 100;         // browser top=0 at top, so invert

      const dot = document.createElement('div');
      dot.className = 'marker';
      dot.style.left = leftPct + '%';
      dot.style.top  = topPct  + '%';

      const tip = document.createElement('div');
      tip.className = 'tooltip';
      tip.textContent = `${p.name} @ <${p.x.toFixed(1)}, ${p.z.toFixed(1)}> id=${p.id}`;
      dot.appendChild(tip);

      mapWrap.appendChild(dot);
    }
  }
})();
</script>
</body>
</html>
